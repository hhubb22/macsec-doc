# 文章 7 — 运维与监控

学习目标：建立可观测、可告警、可追溯的 MACsec 运行体系，覆盖日常巡检、异常定位与容量规划。

## 7.1 可观测性框架

- 指标（Metrics）：每接口/每 SC/每 SA 的收发量、丢弃原因、PN 与重放窗口状态、机密性偏移使用率。
- 事件（Events）：PN 耗尽预警、校验失败、授权/成员变化、重键开始/完成/失败。
- 日志（Logs）：wpa_supplicant/MKA、设备系统日志与安全审计日志。
- 拓扑/状态：CA 成员列表、SCI 映射、Cipher Suite 能力与限制。

## 7.2 SecY 管理与常用开关

- `protectFrames`：是否对受控端口帧进行加密/完整性保护。
- `validateFrames`：严格/检查/关闭，决定接收侧的验证策略。
- `replayProtect`/`replayWindow`：是否启用重放保护与窗口大小。
- `alwaysIncludeSCI`：是否在帧中显式包含 SCI（便于共享媒体与故障排查）。

## 7.3 关键计数器与阈值

- `InNoSCI`/`UnknownSCI`：对端 SCI 未知/不匹配，常因配置或拓扑不一致。
- `InOverrun`/`LatePN`：重放窗口命中或 PN 回退，关注链路乱序与窗口设置。
- `InFailedIntegrity`：ICV 校验失败，排查密钥不同步、套件/偏移不一致或报文损坏。
- `OutTooLong`/`InTooShort`：长度异常，关注 MTU、SL 编码与中间设备的填充/裁剪。
- 阈值：`rekeyThreshold`（PN 使用率）、`errorRate`（每分钟错误计数）驱动预警或触发自动化操作。

## 7.4 SNMP/MIB 与北向集成

- IF-MIB 建模：受控/非受控端口作为子层接口纳入 ifTable，继承带宽/状态指标。
- SecY MIB：提供对象表用于读取/配置 Cipher Suite、SCI/SA 映射、计数与告警；与 Syslog/Telemetry 联动。
- 安全建议：SNMPv3 + 访问控制；关键对象（如 PN/SAK 状态）限制只读并遮蔽敏感细节。

## 7.5 巡检与日常运维

- 每日：错误/丢弃速率、成员变化、重键事件、LLDP 邻居一致性。
- 每周：PN 使用率、窗口命中率、带宽/延迟与 SLO 对齐度。
- 每月：套件能力审查、固件/软件升级计划、PICS 清单复核与演练。

## 7.6 故障场景与处置流程

1) 大面积验证失败：先降级为 `validateFrames=check` 与 `protectFrames=off`，恢复业务 → 快速定位密钥协商/拓扑问题 → 回滚或修复后再转严格。
2) 单点异常丢弃：抓包观测 0x88E5、TCI/PN，核对对端 SCI/AN 与窗口；必要时刷新 SA（重键）。
3) 性能退化：检查硬件加速状态、ICV 长度配置、偏移与 MTU，评估是否需要拆分 SC 或升级设备。

## 7.7 SLO 与容量规划

- 关键 SLO：可用性（含重键成功率）、延迟上限、加密吞吐、验证失败率、恢复时间。
- 容量规划：按峰值带宽与重键频度评估 CPU/ASIC 余量，避免在重键/升配窗口发生抖动。

本篇构建了“看得见、控得住”的运行框架。接下来用系统化的测试与合规流程，确保实现“做得对、做得稳”。

