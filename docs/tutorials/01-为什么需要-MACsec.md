# 文章 1 — 为什么需要 MACsec

学习目标：用通俗语言理解“为什么要在二层做安全”，MACsec 解决了什么问题、适合哪些场景、与其他安全方案有什么不同，并能带着清晰的预期进入后续学习与实践。

---

## 1.0 一页速览（先看结论）

- MACsec 是“逐跳（Hop-by-Hop）的以太链路加固”，侧重“帧完整性/来源认证 + 可选机密性 + 重放防护”。
- 它补齐了“二层控制面与本地承载”的安全短板，与 TLS/IPsec（端到端）互补而非替代。
- 常见收益：降低拓扑震荡与欺骗风险、提升共享承载网的租户隔离、满足合规要求。
- 常见限制：不隐藏通信存在性/长度；被纳入信任域的节点内部作恶不在覆盖范围内；仍需 802.1X/MKA 做认证与密钥分发。
- 适合从“小范围链路/核心互联”开始渐进部署，注意 MTU、性能、旁路流量与监控四件套。

---

## 1.1 问题背景与现实威胁

在现代企业园区、政府、金融与运营商网络中，二层以太网络（IEEE 802）规模庞大、物理接入点繁多。常见风险包括：

- 窃听与被动分析：物理接入或旁路设备捕获交换流量，泄露业务与控制信息。
- 篡改与欺骗：伪造生成树/链路聚合/路由邻居报文，导致拓扑震荡或流量黑洞。
- 重放与降级：重复发送历史帧扰乱状态机，或诱导协议回落到弱安全形态。
- 共享基础设施隔离失效：不同租户/业务在同一承载网中相互影响。

仅依赖物理隔离成本高昂，且在大规模场景中不可持续；仅依赖三/四层加密（如 IPsec/TLS/QUIC）虽能保护应用数据，却难以阻断二层攻击对网络控制面的破坏。

> 直觉比喻：把二层链路想成“楼层间的走廊”。TLS/IPsec 给包裹本身上锁，但走廊上的指示牌和路由仍可能被人故意改动。MACsec 是在走廊两端加上防护门与摄像头，阻止篡改与冒充，并可选让路过的人看不清包裹内容。

---

## 1.2 MACsec 是什么：目标、作用域与价值

MACsec（IEEE 802.1AE）是链路层（逐跳，Hop-by-Hop）的安全机制，保护同一二层链路上两端的 SecY 实体之间的帧。它提供：

- 完整性与来源认证（始终启用）：确保帧未被篡改，且来源为受信端口成员。
- 机密性（可配置）：GCM-AES 套件（128/256 位）。可配置 Confidentiality Offset（0/30/50 字节）以便对前部字段留明文用于分类/检测。
- 重放防护：基于单调递增的 Packet Number（PN）与可配置重放窗口，窗口外/倒序帧丢弃。
- 有界接收延迟：在实现约束内保障时效性，适配工程网络需求。

它能带来的价值：

- 保护网络控制平面的二层承载（桥接/路由/聚合/发现等），减少拓扑震荡与异常收敛。
- 为运营商/企业的共享基础设施提供更强的租户隔离与互信边界治理。
- 渐进式部署：同一 LAN 可并存受保护与未受保护流量，便于有序上线。

威胁—能力对照速查：

| 威胁/风险                 | MACsec 是否覆盖 | 说明 |
|---|---|---|
| 窃听与被动分析           | ✅（启用机密性时） | 加密帧负载抑制嗅探与内容分析；通信存在性与长度仍可见。 |
| 篡改与伪造               | ✅               | ICV 校验与来源认证阻断非成员与篡改帧。 |
| 重放攻击                 | ✅               | PN + 重放窗口防护。 |
| 控制面承载被攻击         | ✅               | 控制协议承载在受控端口时得到保护（例外见 1.3“旁路流量”）。 |
| 端到端应用语义保护       | ❌（需上层协议） | 仍推荐 TLS/QUIC 等端到端安全。 |
| 被信任节点内部作恶       | ❌               | 一旦加入信任域，内部行为不受 MACsec 限制。 |
| 隐匿通信存在性/长度特征 | ❌               | 需结合上层填充/整形策略。 |

---

## 1.3 能与不能：明确边界（非常重要）

- 不能替代身份认证与授权：认证/密钥分发由 802.1X/MKA 完成（EAPOL/MKA 报文走 Uncontrolled Port，明文可见）。
- 不能防止被信任节点作恶：被纳入同一 CA 的节点一旦失陷，其内部行为不受 MACsec 约束，需配合 NAC/微隔离/零信任策略。
- 不隐藏通信存在性与长度：外层 DA/SA、SecTAG/ICV 可见；VLAN 是否可见取决于 SecY 与 VLAN 的插位（ISS/EISS）。
- 不代替端到端安全：应用仍需 TLS/QUIC 等端到端保护其业务语义与跨域信任。

---

## 1.4 与相关标准的关系（如何拼起来）

- IEEE 802.1X（含 MKA）：端口接入控制与 MACsec Key Agreement，负责认证、授权与 SAK 分发。
- IEEE 802.1AC：定义 MAC Service/ISS/EISS 抽象，决定 MACsec 的插入位置与服务语义（是否在 VLAN/优先级之上或之下）。
- IEEE 802.1Q：VLAN 与桥接架构，影响设备集成与提供商网络场景。
- 802.1AE 扩展：后续扩展支持 XPN（扩展 PN）、更强套件等增强能力。

> 合理理解：802.1X 解决“谁是成员 + 分发密钥”，802.1AE 负责“如何保护帧”，802.1AC/802.1Q 决定“在协议栈哪个层位插入保护”。

---

## 1.5 与其他安全方案的对比（该用谁？）

| 方案 | 保护范围 | 信任边界 | 主要目的 | 典型场景 | 与 MACsec 的关系 |
|---|---|---|---|---|---|
| TLS/QUIC | 端到端（应用会话） | 主机/进程 | 保护应用语义与隐私 | 互联网/零信任应用 | 互补；MACsec 不取代应用加密 |
| IPsec | 端到端/站到站（IP 层） | 网络边界设备/主机 | 隧道/传输保护、跨网段 | 数据中心、分支互联 | 互补；MACsec 保护链路，IPsec 跨域 |
| MACsec | 逐跳（二层链路） | 相邻节点（SecY 之间） | 控制面与本地承载加固 | 园区/数据中心/运营商二层 | 与上两者叠加更稳健 |
| 802.11 加密 | 无线链路（二层） | AP–STA | 无线隐私与接入控制 | WLAN | 思路类似但标准不同 |

实践建议：

- 端到端仍优先使用 TLS/QUIC；数据中心/跨域选 IPsec/VPN；本地二层链路加固用 MACsec。三者叠加并不冲突，按威胁模型与运维成本取舍。

---

## 1.6 典型拓扑与适用场景（看图更直观）

1) 点到点链路（核心–核心 / 服务器–汇聚）

```
[Node A: SecY] ===(MACsec 保护)=== [SecY: Node B]
```

- 最容易落地；适合先行试点与高价值链路加固。

2) 链路聚合 LAG（LACP）

```
[SecY]===Eth1===\
                 LAG ===(MACsec)=== [LAG]===Eth1===[SecY]
[SecY]===Eth2===/
```

- 关注乱序与重放窗口设置；核对厂商对 LAG+MACsec 的支持矩阵。

3) 运营商 EDE 场景（Encrypt–Decrypt–Encrypt）

```
客户侧(黑) —— EDE-M ——(受保护的运营商段)—— EDE-M —— 客户侧(黑)
```

- 在红/黑侧提供透明加固；适合共享承载或多租户隔离。

4) 工业与政务专网

- 物理接入不可控、对时延敏感；选择合适的机密性偏移并评估 PTP/检测系统兼容性。

---

## 1.7 上线前 Checklist 与易踩坑

上线前 Checklist：

1. MTU：根据 `SecTAG + ICV` 开销（约 32–40B）调整链路 MTU 或上层 MSS。
2. 性能：确认硬件卸载（AES-GCM、PN 窗口、并发 SA 数），压测时延与抖动。
3. 旁路流量：理清 EAPOL/MKA、LLDP/LACP/OAM 等是否受控，必要时纳入白名单/监控。
4. 密钥与轮换：MKA 活跃超时、轮换阈值、fail-open/fail-close 策略达成一致。
5. 重放窗口：结合链路抖动/ECMP 乱序设定窗口，避免误丢同时兼顾安全。
6. 机密性偏移：是否保留明文头部用于分类/检测；两端一致。
7. 监控：按 SCI/SA 暴露计数与丢弃原因，接入告警/日志。
8. 互通：实验室逐项对表 Cipher/CO/SCI 显式与否/窗口/MKA 参数。

易踩坑（Top 5）：

- MTU 未调优 → 上线即碎片/丢包。
- LACP/STP/LLDP/BFD 等控制面受控范围不清 → 误判为“设备异常”。
- 重放窗口过小 → 抖动/乱序链路下误丢。
- 监控缺失 → ICV 失败或 PN 溢出时难以定位。
- 套件/策略不一致或不支持 256-bit → 跨域互通失败。

---

## 1.8 快速实践预览（2 分钟了解怎么动手）

- 你可以用两台 Linux 主机在直连链路上演示 MACsec：
  - 路径 A：使用静态密钥（不依赖 MKA，适合入门演示）。
  - 路径 B：使用 wpa_supplicant 的 MKA（更接近生产）。
- 建议直接参考“文章 4 — 动手实验：最小 MACsec 网络”，包含完整命令、抓包验证与排错：
  - 详见：`04-动手实验-最小网络.md`

---

## 1.9 常见问题（FAQ）

- 开了 MACsec 还需要 TLS/IPsec 吗？
  - 需要。MACsec 保护二层链路与控制面承载，不保护应用语义。端到端安全仍依赖 TLS/QUIC/IPsec。
- VLAN 会不会被加密？
  - 取决于 SecY 插入在 VLAN 的之上还是之下。如果在之上，VLAN 头部也会被机密性覆盖；反之则明文可见。
- 所有帧都会被保护吗？
  - 不。EAPOL/MKA 等控制流走 Uncontrolled Port，通常不被 MACsec 保护；其余是否受控取决于策略与实现。
- 会不会影响时延与吞吐？
  - 视硬件卸载与配置而定。多数交换/网卡的 MACsec 支持可做到近线速；仍需评估 MTU、机密性偏移与窗口设置的影响。
- 与 LAG/ECMP/环网协议能共存吗？
  - 通常可以，但需验证乱序与重放窗口、以及不同厂商的实现细节。

---

## 1.10 结语：从“为什么”到“怎么做”

到此你应当清楚“为什么需要在二层做安全”，知道 MACsec 与其他方案的边界和互补关系，并掌握落地前要思考的关键点。接下来建议顺序：

- 打牢概念：`02-入门概念速通.md`（CA/CKN/CAK、SC/SA/SAK、SCI、SecTAG/ICV、受控/未受控端口、XPN、机密性偏移等）。
- 了解原理：`03-工作原理总览.md`（建立、收发、重键与无缝切换）。
- 跑通实验：`04-动手实验-最小网络.md`（静态密钥与 MKA 两条路径）。
- 走向生产：`05-走向生产-部署指南.md`（选型、规划、上线与运维）。

带着这些“为什么”和“怎么做”，你就可以从小规模链路开始，渐进式把 MACsec 带入你的网络。
