# 文章 2 — 入门概念速通

学习目标：在不预设“ISS/EISS”等背景的前提下，先用你熟悉的以太网知识（MAC、VLAN）理解 MACsec 的基本对象与帧格式，再逐步引入更专业的术语与接口模型，最后给到联调与自测清单。

阅读建议：从 2.0 到 2.5 顺序阅读即可建立 80% 认知；2.6（ISS/EISS）为选读，适合想了解“MACsec 插在协议栈哪一层”的读者。

---

## 2.0 从以太网帧开始（3 分钟打底）

你已经知道一帧以太网长这样：

```
[ DA ][ SA ][ EtherType ][ Payload ... ][ FCS ]
```

带 VLAN 时通常是：

```
[ DA ][ SA ][ 0x8100 ][ VLAN Tag ][ EtherType ][ Payload ... ][ FCS ]
```

开启 MACsec 后，链路上的帧“外观”会变为：

```
[ DA ][ SA ][ 0x88E5 ][ SecTAG ... ][ Secure Data ... ][ ICV ]
```

- DA/SA 仍然明文可见（用于二层转发）。
- EtherType 变为 0x88E5，表示“这是一个 MACsec 帧”。
- SecTAG 是一小段额外头部，告诉对端当前使用哪条密钥、是否加密、是否启用重放防护等。
- Secure Data 承载原本的业务数据（以及可能的 VLAN 头，取决于插位）；是否加密取决于配置。
- ICV 是校验值，用于保证“没有被篡改且来源可信”。

先记住这三件事就够了：

- MACsec 让“二层帧”变成“0x88E5 + SecTAG + ICV”的样子；
- 控制“是否加密/怎么验证”的关键字段都在 SecTAG 里；
- 机密性是可选的，但“来源认证 + 完整性 + 重放防护”始终存在。

---

## 2.1 最少必要概念（先会这 5 个）

- SecY：实现 MACsec 的逻辑实体，掌管验证、重放防护和（可选）加密。
- 三个端口：
  - Controlled Port：安全的上行服务口，业务帧进出都要验证/解密。
  - Uncontrolled Port：放行 EAPOL/MKA/LLDP/LACP 等控制流（明文）。
  - Common Port：与底层网卡/端口交互，实际收发帧。
- CA（Connectivity Association）：被认证为“同一安全域”的一组 SecY 成员。
- SC（Secure Channel，单向）：由发送者的 SCI 唯一标识的逻辑信道。
- SA（Secure Association）：SC 的“一个密钥时代”（SAK+PN）；通过 AN 选择当前 SA，可无缝轮换。

直觉比喻：CA=群聊，SC=你发言的一个单向话筒，SA=这只话筒当前装的电池（电量=PN，快耗尽就换）。

---

## 2.2 一帧如何被保护（最关键流程）

发送侧（Protect）：

1) 选择当前 SA（由 AN 指定），取出 SAK 和下一次的 PN；
2) 生成 SecTAG（0x88E5、TCI 标志、AN、PN 低 32 位，可选 SCI/SL）；
3) 调用 Cipher Suite：计算 ICV，并按需加密 Secure Data；
4) 发出 `[DA|SA|0x88E5|SecTAG|Secure Data|ICV]`。

接收侧（Validate）：

1) 读取 SecTAG，定位 (SCI, AN) 对应的接收 SA；
2) 用 PN 做重放检查（是否单调、是否在窗口内）；
3) 用 SAK 计算并比对 ICV（通过则可信）；
4) 若已加密则解密，向 Controlled Port 递交明文。

这就解释了前一节的“三件事”。更多细节请参考“文章 3 — 工作原理总览”。

---

## 2.3 CA / SC / SA：层级与轮换

- CA：经认证授权的一组成员；在同一 CA 内的成员可以互相收发受保护帧。
- SC（单向）：由发送者的 SCI 唯一标识；可按策略为不同优先级拆分多个 SC（两端需一致）。
- SA：SC 的密钥时代（绑定 SAK 与单调递增 PN）；通常至少准备两条 SA 做平滑轮换，避免中断。

示意：

```
发送者X的SC（SCI唯一）
 ├─ SA[AN=0]：SAK0 + PN↑
 ├─ SA[AN=1]：SAK1 + PN↑
 └─ SA[AN=2]：...
```

联调要点：保证 AN 同步、PN 单调，预留轮换空间。

---

## 2.4 SCI / SAK / PN 与 SecTAG（看懂表头就会用）

- SCI（Secure Channel Identifier）= MAC(48) + PortID(16)，区分同一发送者的多个 SC。
- SAK（Secure Association Key）：该 SA 的密钥。
- PN（Packet Number）：发送端严格单调递增；接收端用窗口做重放防护。
- SecTAG（EtherType=0x88E5）常见字段：
  - TCI：是否加密、是否携带 SCI、是否启用重放保护等标志；
  - AN：选择 SC 中的哪条 SA；
  - PN（低 32 位在线携带）；
  - SCI（可选 8 字节）；
  - SL（可选，短帧长度）。
- ICV：完整性校验值，覆盖 DA/SA、SecTAG（含可选 SCI）与 Secure Data。

保护范围速查：

| 字段/范围                            | 上线上是否明文                 | 是否被完整性保护          | 备注 |
| -------------------------------- | ----------------------- | ----------------- | ---- |
| DA/SA                            | 明文                      | 是                 | ICV 覆盖 |
| SecTAG（TCI/AN/PN低32/SCI可选/SL） | 明文                      | 是                 | EtherType=0x88E5 |
| Secure Data（MSDU）                 | 取决于是否开启机密性与偏移       | 是（不论密文/明文）        | 机密性只作用于载荷 |
| VLAN Tag                         | 取决于 SecY 与 VLAN 的插位     | 取决于是否被纳入载荷/头部   | 插位一致性关键 |

工程提示：

- 机密性偏移（0/30/50 常见）：保留前 N 字节明文以便分类/检测；两端一致。
- MTU：考虑 `SecTAG + ICV` 开销（约 32–40B），必要时调大底层 MTU 或上层 MSS。

---

## 2.5 Cipher Suite 与 XPN（何时选什么）

- 常用套件：GCM-AES-128/256（认证 + 可选加密）。
- XPN（GCM-AES-XPN-128/256）：
  - 将 PN 扩展到 64 位，与 SSCI 组成 96 位 IV；
  - 线上仍只携带 PN 低 32 位（高 32 位参与 IV/KDF，不上线）；
  - 适合高速/大流量/长寿命链路，避免 32 位 PN 提前耗尽；或按对端策略统一。

联调提示：两端 Cipher/XPN/机密性偏移/SCI 携带策略需一致。

---

## 2.6 MAC Service 与接口栈（ISS/EISS，选读）

如果你想知道“MACsec 插在以太协议栈的哪一层”，再看本节；否则可跳到 2.7。

- MAC Service（802.1AC）：无连接、尽力而为的二层服务；参数包含源/目的地址、优先级、MSDU。
- ISS/EISS：桥/VLAN 感知功能使用的内部服务抽象。SecY 作为媒体无关功能位于 MAC 之上、其他子层（如 VLAN）之下或并列；关键是两端插位顺序保持一致。

示意：

```
   上层（桥/VLAN感知、转发、ACL/分类）
               ▲      ▲
               │      │ISS/EISS（内部服务接口）
               │      │
           [ Controlled Port ]   ——  安全的MAC Service（验证/可选加密）
                │
               SecY（MAC Security Entity）
                │
           [ Uncontrolled Port ] ——  802.1X/EAPOL/MKA 等未受保护控制流
                │
           [   Common Port   ]   ——  与底层MAC交互（实际收发）
                │
               物理链路 / LAG / PHY
```

工程提示：

- 事先约定“SecY 相对 VLAN 的插位”：
  - SecY 在 VLAN 之下 → VLAN 明文可见，便于交换/分类；
  - SecY 在 VLAN 之上 → VLAN 被机密性覆盖，隐私更好。
- 插位不同会影响机密性偏移与 MTU 预算。

---

## 2.7 认证与密钥协商（PAE/KaY/MKA）

- PAE：802.1X 端口接入实体，负责 EAPOL 交换与接入控制。
- KaY：Key Agreement 实体，运行 MKA；负责认证/授权、建立 CA、分发/轮换 SAK，并通知 SecY 切换 SA/AN。

联调 Checklist：

- 身份与组网：CKN/CAK 来源一致（EAP/PSK）；角色匹配（Authenticator/Supplicant）；SCI 唯一。
- 参数一致性：Cipher Suite、是否 XPN、机密性偏移、SCI 携带策略、重放窗口大小。
- 链路与 MTU：确认 `SecTAG+ICV` 后仍满足 MTU；必要时调大接口 MTU。
- 观测与告警：关注 `ICV failures / Not in CA / AN out-of-sync / PN too old/too high` 等计数。

---

## 2.8 EDE 与系统集成（802.1Q / LAG/ECMP）

- EDE（Ethernet Data Encryption device）：两端口桥设备，红侧接客户，黑侧接运营商；内部串接若干 SecY 实现透明加固。

示意：

```
 客户网（红） ──[ Controlled/Common ]── SecY/EDE ──[ Common ]── 运营商网（黑）
                         ▲                       ▲
                [ Uncontrolled ]          放通 LLDP/LACP/EAPOL/MKA 等
```

- VLAN-aware 桥 & 链路聚合：
  - 关注 VLAN 头部的插位（见 2.6）；
  - LAG/ECMP 的多路径乱序会消耗接收端重放窗口：窗口要与队列深度/乱序度匹配，否则合法帧会被当作重放丢弃。

实操要点：明确控制面允许列表（EAPOL/MKA/LLDP/LACP），检查运营侧是否过滤这些帧。

---

## 2.9 快速自测

1) 画出“开启 MACsec 前后”的帧对比（含 0x88E5、SecTAG、ICV）。
2) 解释 CA–SC–SA 的层级关系与轮换方式。
3) SCI 由哪两部分组成？在多端口/虚拟化场景如何保证唯一？
4) 何时需要 XPN？为何线上仍只带 PN 低 32 位？
5) Controlled / Uncontrolled / Common 三端口分别承载哪些流量？

参考要点：

- CA=成员集合；SC=单向、由 SCI 标识；SA=密钥时代（SAK+PN），由 AN 选择，连续 SA 形成无缝轮换。
- SCI=MAC(48)+PortID(16)。
- XPN=64 位 PN（与 SSCI 组成 96 位 IV），用于高速/长寿命链路；线上只携带低 32 位。
- 三端口：Controlled=用户数据（验证/可选加密）；Uncontrolled=EAPOL/MKA/LLDP/LACP 控制面；Common=与底层 MAC 的实发实收。

---

## 术语与缩略语对照

SecY / SC / SA / SAK / PN / AN / SCI / SSCI / TCI / ICV / PAE / KaY / MKA / ISS / EISS / EDE / PCP

---

### 小结与下一步

- 只要把“帧长相（0x88E5+SecTAG+ICV）”、“CA–SC–SA”、“SCI/SAK/PN 与重放窗口”、“Cipher/XPN/机密性偏移/MTU 一致性”四件事吃透，90% 的联调问题都能提前规避。
- 下一篇：`03-工作原理总览.md`（建立、收发、重键与无缝切换），结合 `04-动手实验-最小网络.md` 动手实践更快形成肌肉记忆。

