# 文章 4 — 动手实验：最小 MACsec 网络

学习目标：在两台主机/交换机之间启用 MACsec，完成连通性测试、抓包验证与常见问题排查。提供两套路径：

- 路径 A：Linux 静态密钥（快速上手，适合实验，不依赖 802.1X/MKA）
- 路径 B：Linux + wpa_supplicant（使用 MKA 协商，更接近生产）

> 注意：不同发行版的工具与内核版本可能略有差异，请据实调整命令与模块名。

---

## 4.1 实验拓扑与前提

- 两台 Linux 主机（Host A/B），二层直接相连（例如 `eth0<->eth0`）。
- root 权限；`iproute2` 版本支持 `macsec`；（路径 B）安装 `wpa_supplicant`，版本需含 MKA 支持。
- 可选：第三台用于旁路抓包的监听主机。

测试网段：`192.168.10.0/30`（A: .1，B: .2）。

---

## 4.2 路径 A：静态密钥快速上手（无需 MKA）

### 4.2.1 Host A

```
# 设定本端 SCI（MAC+端口），以实际 MAC 为准；示例 02:00:00:00:00:0A/0001
MY_MAC=$(cat /sys/class/net/eth0/address)
MY_SCI_HEX=$(echo $MY_MAC | tr ':' '-' ):00-01

# 创建 macsec 设备（开启加密，ICV 16 字节，GCM-AES-128）
ip link add link eth0 macsec0 type macsec encrypt on icvlen 16 cipher gcm-aes-128

# 对端 SCI（替换为 Host B 的 MAC），示例 02:00:00:00:00:0B/0001
PEER_SCI_HEX="02-00-00-00-00-0B:00-01"

# 允许接收来自对端 SCI 的帧
ip macsec add macsec0 rx sci $PEER_SCI_HEX on

# 配置本端发送 SA（AN=0，PN 从 1 开始，密钥标识 01，16 字节示例）
ip macsec add macsec0 tx sa 0 pn 1 on key 01 00112233445566778899aabbccddeeff

# 为接收方向配置匹配的 SA（AN=0，密钥与对端发送相同）
ip macsec add macsec0 rx sci $PEER_SCI_HEX sa 0 pn 1 on key 01 00112233445566778899aabbccddeeff

# 启动并配置地址
ip link set macsec0 up
ip addr add 192.168.10.1/30 dev macsec0
```

### 4.2.2 Host B（对称配置）

```
MY_MAC=$(cat /sys/class/net/eth0/address)
MY_SCI_HEX=$(echo $MY_MAC | tr ':' '-' ):00-01
ip link add link eth0 macsec0 type macsec encrypt on icvlen 16 cipher gcm-aes-128

PEER_SCI_HEX="02-00-00-00-00-0A:00-01"  # 替换为 A 的 MAC
ip macsec add macsec0 rx sci $PEER_SCI_HEX on

ip macsec add macsec0 tx sa 0 pn 1 on key 01 00112233445566778899aabbccddeeff
ip macsec add macsec0 rx sci $PEER_SCI_HEX sa 0 pn 1 on key 01 00112233445566778899aabbccddeeff

ip link set macsec0 up
ip addr add 192.168.10.2/30 dev macsec0
```

### 4.2.3 验证与观察

```
# 互相 ping
ping -c 3 192.168.10.2   # A -> B
ping -c 3 192.168.10.1   # B -> A

# 查看 macsec 统计
ip -s link show macsec0

# 旁路主机抓包（或在本机 eth0 上抓链路报文）应能看到 0x88E5 帧，PN 递增
tcpdump -i eth0 -nn ether proto 0x88e5
```

> 小结：静态密钥方案不依赖 802.1X/MKA，适用于教学与连通性演示；不建议用于生产。

---

## 4.3 路径 B：wpa_supplicant + MKA（接近生产）

### 4.3.1 基本思路

- 使用 `wpa_supplicant` 的 MKA 功能在 Uncontrolled Port 上进行成员认证与密钥分发；
- 由 `macsec` 接口作为受控端口收发加密流量；
- 认证方式可以是 EAP（接入控制器）或 PSK（实验）。

### 4.3.2 示例配置（PSK 实验模式）

`/etc/wpa_supplicant/wpa_supplicant-macsec.conf`（两端一致）：

```
ctrl_interface=/var/run/wpa_supplicant
ap_scan=0

network={
    key_mgmt=MACSEC_PSK
    macsec_policy=1            # 要求必须使用 MACsec
    mka_cak=00112233445566778899aabbccddeeff  # CAK（示例）
    mka_ckn=00112233445566778899aabbccddeeff0011223344556677  # CKN（示例）
    eapol_flags=0
}
```

启动（以 `eth0` 为基础端口）：

```
wpa_supplicant -i eth0 -D macsec_linux -c /etc/wpa_supplicant/wpa_supplicant-macsec.conf -B

# 关联生成的 macsec 接口（通常命名 macsec_eth0），配置地址
ip addr add 192.168.10.1/30 dev macsec_eth0   # 在 A 侧
ip link set macsec_eth0 up
```

> 提示：不同版本的 `wpa_supplicant` 与内核可能使用 `macsec_sockets/macsec_linux` 等驱动名；可查看 `wpa_supplicant -h` 与日志确定。

### 4.3.3 验证要点

- `ip -s link show macsec_eth0`：应看到加密统计递增，且无大量验证失败。
- `tcpdump -i eth0 ether proto 0x88e5`：可见 MACsec 帧；
- 观察日志：看到 CA 建立、SA 下发与轮换事件。

---

## 4.4 常见问题排查

- 无法连通：确认双方 MACsec 接口均 up、IP 配置在 MACsec 接口上、物理链路无环路保护限制。
- 验证失败（inval/integrity errors）：检查密钥（路径 A）、CKN/CAK（路径 B）、机密性偏移与 Cipher Suite 是否一致。
- 未见 0x88E5：抓物理口而非 MACsec 虚拟口；或 MACsec 未启用/仍在 Uncontrolled Port。
- MTU 问题：MACsec 增加额外开销，可适当提高底层 MTU 或调整上层 MSS。
- PN 耗尽：日志会提示阈值接近，应触发重键策略；若为静态密钥，请重置 PN（会中断）。

---

## 4.5 进阶练习

- 为不同优先级分配独立 SC，观察重放窗口与乱序的关系。
- 在 LACP 聚合链路上开启 MACsec，评估乱序与吞吐影响。
- 开启/关闭机密性以对比抓包可见性与性能差异。

完成本实验后，你已能“让 MACsec 跑起来”。下一篇将把场景扩展到 VLAN、链路聚合与运营商网络等生产环境。

