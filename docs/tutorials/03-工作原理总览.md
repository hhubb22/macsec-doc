# 文章 3 — 工作原理总览

学习目标：系统理解 MACsec 的建立、收发与重键流程，并能读懂关键字段与时序。

## 3.1 整体流程鸟瞰

1) 物理与二层建立：链路协商完成，端口 Up。
2) 认证与授权（802.1X/MKA）：在 Uncontrolled Port 发送 EAPOL，PAE 完成双向认证，KaY 运行 MKA 决定成员资格与策略。
3) 建立 CA/SC/SA：KaY 以策略为依据，建立 CA，分发初始 SAK，指配每个发送者的 SCI/SC 结构，SecY 更新本地表项。
4) 保护与验证：受控端口请求由 SecY 保护后下送 Common Port；接收侧完成验证后再上送受控端口客户端。
5) 周期重键与异常：KaY 根据 PN/时间/策略触发重键；对端无缝切换；异常状态通过 LMI/计数器曝光。

## 3.2 帧保护（发送）

发送路径步骤（PROTECT）：

1. SA 选择：根据当前 SC 的活跃 SA（由 KaY 指示）与优先级策略选择。
2. PN 处理：取 `nextPN` 并递增，确保单调；接近阈值时上报告警以触发重键。
3. 构造 SecTAG：
   - EtherType：0x88E5。
   - TCI：协议版本、是否包含 SCI、是否加密、重放保护等。
   - AN：标识当前 SA（0–3）。
   - SL（可选）：载荷小于 48 字节时标注短长度。
   - PN：低 32 位，XPN 模式还需在接收侧恢复高 32 位。
   - SCI（可选）：点到点单 SC 可省略；共享媒体/多 SC 建议显式携带。
4. 调用 Cipher Suite：以 SAK、PN、SCI、地址、SecTAG、数据为输入，输出 Secure Data + ICV（GCM Tag）。
5. 发送：提交给 Common Port。

## 3.3 帧验证（接收）

接收路径步骤（VALIDATE）：

1. 预检查：EtherType/TCI/长度/SL 等是否合法，不合法直接丢弃并计数。
2. SA 查找：用（SCI, AN）索引接收 SA，获得 SAK 与重放窗口状态；点到点未显式携带 SCI 时使用管理配置的隐式值。
3. PN 重建与重放检查：XPN 还需恢复高 32 位；小于窗口下界或重复者丢弃并计数。
4. 验证与解密：调用 VALIDATE 计算 ICV，比对成功则可选解密得到明文 MSDU。
5. 投递：向受控端口上送并更新统计。

## 3.4 重键与无缝切换

- 触发：基于 PN 阈值、时间间隔或策略事件（成员变化）。
- 要求：
  - 新 SAK 在 1 秒内准备就绪。
  - 发送侧在 1 帧时间内切换至新 SA。
  - 接收侧同时持有前/当前两把 SAK，保证跨帧无缝切换。
- 不同 Cipher Suite 间通常不要求无缝切换（需重建会话）。

## 3.5 重放保护与乱序

- 重放窗口：按窗口下界与最近 PN 维护，拒绝回退 PN 的报文。
- 乱序：链路聚合/优先级分队列可能导致乱序，推荐按优先级划分 SC 或放宽窗口以抵御少量乱序。

## 3.6 机密性偏移与明文字段

- 机密性偏移：保留前 0/30/50 字节明文，便于分类/运维；注意暴露元数据与隐私权衡。
- 明文不等于不保护：即便不加密，完整性与来源仍由 ICV 保障。

## 3.7 关键失败与可观测性

- 典型丢弃原因：长度非法、未知 SCI/SA、重放失败、ICV 验证失败、PN 回绕/耗尽。
- 观测手段：SecY 计数器、事件告警（PN 耗尽、验证失败）、MIB 数据、抓包看 EtherType 和 TCI/PN 递增。

## 3.8 小结

掌握上述收发/重键流程与字段语义后，你已具备阅读/调试 MACsec 的基础。下一篇将动手搭建一个最小可用网络，从“能跑起来”入手练习配置与排错。

