# 文章 3 — 工作原理总览（扩展版）

学习目标：在不查标准原文的前提下，系统掌握 MACsec 的端到端工作机制，从“链路就绪 → 认证授权 → 建立安全关系 → 收发保护/验证 → 重放与重键 → 观测与排错”。你将获得：

- 一套清晰的心智模型（SecY/端口/CA/SC/SA）
- 关键字段与帧格式的直观解释（SecTAG/TCI/PN/SCI/ICV）
- 发送/接收路径的逐步流程与伪代码
- 重放窗口、乱序与重键的实践建议
- MTU/性能、机密性偏移与 VLAN 插位的工程要点
- 抓包与计数器的自检方法

建议先读“文章 2 — 入门概念速通”（docs/tutorials/02-入门概念速通.md），对名词有基本认识；想上手实操可接着看“文章 4 — 动手实验”（docs/tutorials/04-动手实验-最小网络.md）。

---

## 3.1 架构与角色（快速建立直觉）

核心参与者与接口：

- SecY：实现 MAC 安全（保护/验证/重放/可选加密）。
- 三个“口”：
  - Controlled Port：安全上行口，业务帧进入前要验证（并可能解密）。
  - Uncontrolled Port：控制流（EAPOL/MKA/LLDP/LACP 等）明文通行。
  - Common Port：与底层网卡/端口交互，实际收发帧。
- KaY：Key Agreement 实体，运行 MKA，建立 CA、分发/轮换 SAK，指导 SecY 切换 SA/AN。

示意（抽象的数据通路）：

```
  客户端/桥/转发表
         ▲   (安全的MAC Service)
   [ Controlled Port ]
         │  Validate/Decrypt
        SecY  ──────────────── 可选：Protect/Encrypt ─────►  [ Common Port ] ── 物理口
         │
   [ Uncontrolled Port ]（EAPOL/MKA/LLDP/LACP 明文）
```

延伸阅读：协议语义与接口模型见 Clause 10（docs/clauses/10-secy-operation.md）。

---

## 3.2 从上电到“可以收发”的建链时序

1) 物理与二层就绪：链路协商完成，端口 up（`MAC_Operational=TRUE`）。
2) 认证与授权（PAE/MKA）：在 Uncontrolled Port 上进行 EAPOL 交换，KaY 运行 MKA 完成以下动作：
   - 双向认证（谁→谁）与成员授权（哪些 SecY 在同一 CA）。
   - 协商 Cipher Suite、是否 XPN、机密性偏移、SCI 携带策略、重放窗口等能力。
   - 为每个发送者分配唯一 SCI（MAC+PortID），建立单向的 SC 模板。
3) 下发初始密钥：KaY 为每条 SC 生成/分发第一组 SAK，通常同时准备两条 SA（AN=0/1）以便无缝轮换；SecY 建立本地 SA 表项并初始化 `nextPN`。
4) 进入可用态：SecY 将受控端口置为可用（policy 也可先置于“只验证不加密”模式助于联通性排查）。

简化时序（双端 A/B）：

```
A.KaY         A.SecY                         B.SecY         B.KaY
  | 发现链路/对端  |                               | 发现链路/对端  |
  |<--EAPOL/MKA----|-------------------------------|----EAPOL/MKA-->|
  | 认证/授权/参数  |                               | 认证/授权/参数  |
  |--SAK/SC/AN 下发→|  安装 SA(AN=0/1), init PN     |←SAK/SC/AN 下发--|
  |                 |===> Controlled Port 可用 <===|                 |
```

提示：本阶段发生在 Uncontrolled Port 上，抓包可见 EAPOL/MKA 明文交互（便于排错）。

---

## 3.3 帧格式与 SecTAG 速读（一眼看懂 0x88E5）

链路上的 MACsec 帧外观：

```
[ DA ][ SA ][ 0x88E5 ][ SecTAG ... ][ Secure Data ... ][ ICV ]
```

SecTAG 关键字段（对应 Clause 9，docs/clauses/09-macsec-encoding.md）：

- EtherType：固定 `0x88E5`。
- TCI：若干标志位，包含“是否携带 SCI（SC）/是否机密性（C）/是否重放保护”等；版本位保留。
- AN：2 bit，标识选择哪条 SA（0–3）。
- SL（可选）：当 SecTAG 后的有效载荷 < 48B 时标注短长度，便于接收端定位 ICV。
- PN：低 32 位在帧内携带；XPN 模式下接收端要重建高 32 位。
- SCI（可选 8B）：显式标识发送者；点到点单 SC 可省略，共享媒体/多 SC 建议携带。
- ICV：由套件决定长度（常见 16B），覆盖 DA/SA + SecTAG + Secure Data。

开销（常见配置）：

- 不带 SCI：SecTAG 8B + ICV 16B → 24B
- 带 SCI：SecTAG 16B + ICV 16B → 32B

注意：VLAN 是否落在 Secure Data 内，取决于 SecY 与 VLAN 的插位（见 3.9）。

---

## 3.4 发送路径（Protect）逐步讲解

目标：把受控端口送下来的 MSDU 变成“可在链路上传输且可被对端验证”的 MPDU。

步骤：

1) SA 选择：按策略/优先级找到所属 SC 的当前活跃 SA（AN 由 KaY 指示）。
2) PN 处理：取出 `nextPN` 并自增，确保单调；接近阈值时通过 LMI 告警以触发重键。
3) 构造 SecTAG：写入 `0x88E5`、TCI、AN、（必要时）SL、PN 低 32 位、（按策略）SCI。
4) 调用 Cipher Suite.PROTECT：输入 SAK、PN、SCI、DA/SA、SecTAG、MSDU；输出 Secure Data 与 ICV（GCM Tag）。
5) 发送：拼装并下送给 Common Port。

伪代码（示意）：

```
sa = select_tx_sa(msdu)
pn = sa.nextPN++
sectag = build_sectag(C, SC, AN=sa.an, PN=lsb32(pn), SCI=maybe)
secure_data, icv = PROTECT(SAK=sa.sak, PN=pn, SCI=sectag.sci,
                           DA=msdu.da, SA=msdu.sa,
                           SecTAG=sectag, Payload=msdu.payload)
tx([DA|SA|0x88E5|SecTAG|secure_data|icv])
```

常见问题：

- PN 回绕/耗尽：32 位 PN 在高速/长寿命链路上会较快耗尽，建议使用 XPN 或配置及时重键。
- SCI 携带策略：点到点/单 SC 可省略；若网络中间设备或管理需要识别发送者，建议显式携带。

---

## 3.5 接收路径（Validate）逐步讲解

目标：对从 Common Port 进来的 MPDU 进行合法性检查、重放防护、完整性验证，并递交明文 MSDU。

步骤：

1) 预检查：EtherType/TCI/长度/SL 等基础格式检查，不合法直接丢弃并记数。
2) SA 定位：解析 AN 与（可选）SCI，查找对应接收 SA；点到点未携带 SCI 时使用管理配置的隐式值。
3) PN 重建与重放检查：
   - 非 XPN：直接使用 32 位 PN 做窗口比较；
   - XPN：结合已知的高 32 位重建 64 位 PN；
   - 小于窗口下界、重复或越界者丢弃并计数。
4) 验证与解密：调用 VALIDATE 计算并比对 ICV；机密性开启时解密得到 MSDU。
5) 投递：向受控端口递交 MSDU，并更新 PN/窗口与统计。

伪代码（示意）：

```
if !basic_check(frame): drop(LENGTH/FORMAT)
sa = lookup_rx_sa(frame.AN, frame.SCI or implicit_SCI)
if !sa: drop(UNKNOWN_SA)
pn = reconstruct_pn(sa, frame.PN_L32)
if replay_protect and !replay_window_accept(sa, pn): drop(REPLAY)
ok, msdu = VALIDATE(sa.sak, pn, frame)
if !ok: drop(ICV_FAIL)
deliver_to_controlled(msdu)
```

---

## 3.6 重放窗口与乱序（怎么设才不冤枉丢包）

- 窗口语义：维护“最近接受的最高 PN”和“最低可接受 PN（窗口下界）”，拒绝落在窗口之外或重复的帧。
- 乱序来源：LAG/ECMP 多路径、优先级分队列、设备缓存抖动。窗口过小将把合法乱序当作重放丢弃。
- 建议：
  - 单链路或轻微乱序：窗口 32–64 足够；
  - LAG/深队列：按队列深度和往返抖动预估，常见需 512–2048；
  - 按优先级拆分 SC 可降低乱序对单一窗口的压力（两端需一致映射）。

---

## 3.7 重键（Rekey）与无缝切换（AN 旋转）

触发条件：

- PN 接近阈值（安全上限/预警线）
- 定时策略（例如每 N 分钟）
- 成员变更（有节点加入/离开 CA）

时间与行为要求（实现目标）：

- 新 SAK 在 1 秒内分发并可用；
- 发送侧在“1 帧时间”内完成从旧 SA → 新 SA 的切换；
- 接收侧同时持有“前一把/当前这把”两把 SAK，支持跨帧无缝过渡；
- 不同 Cipher Suite 之间通常不要求无缝切换（必要时重建会话）。

实务建议：

- 提前配置双 SA（AN=0/1），KaY 下发新 SAK 后只需切换活跃 AN；
- 观测计数器 `NotUsingSA/OldKey/PNTooOld`，确保切换窗口内无异常丢弃；
- 将重键与维护时段对齐，避免与批量流量高峰重叠。

---

## 3.8 Cipher Suite 与 XPN（何时需要扩展计数）

- 常用套件：GCM-AES-128/256 提供来源认证 + 完整性 + 可选机密性。
- XPN（GCM-AES-XPN-128/256）：将 PN 扩展至 64 位，并结合 SSCI 形成 96 位 IV；线上仍只携带 PN 低 32 位。
- 适用场景：高速/长寿命链路、大流量业务、严格合规要求；或为与对端能力对齐而统一启用。
- 切换提示：两端需一致选择是否 XPN；从非 XPN 迁移到 XPN 需要重新建立会话。

---

## 3.9 机密性偏移与 VLAN 插位（可见性 vs 隐私）

- 机密性偏移（0/30/50 常见）：保留前 N 字节明文，便于交换/分类/采集；两端一致。
- VLAN 插位：
  - SecY 在 VLAN 之下 → VLAN 明文可见，交换/ACL 更方便；
  - SecY 在 VLAN 之上 → VLAN 被机密性覆盖，隐私更好；
  - 项目中务必在两端与中间设备上统一插位假设，避免分类不一致。
- MTU 预算：考虑 `SecTAG + ICV` 额外 24–32B 开销；必要时提高底层 MTU 或在上层降低 MSS。

---

## 3.10 关键计数器与抓包（观测就是生产力）

抓包入口：

- 物理口（Common Port）：`tcpdump -i ethX -nn ether proto 0x88e5` 可见 PN 递增与 SCI（若显式携带）。
- 受控口（Controlled Port）：通常抓不到 0x88e5，看到的是明文业务帧（已验证/解密）。

计数器（示例，按 Clause 10 分类）：

- 接收丢弃：长度非法、未知 SCI/SA、重放失败、ICV 验证失败、PN 回绕/耗尽。
- 发送异常：PN 耗尽预警、SA 未就绪、AN 未同步。
- 事件：重键开始/完成、加入/离开 CA、策略变更。

自检清单：

- 是否能在物理口看到 0x88E5？PN 是否单调递增？
- `alwaysIncludeSCI/SC 位` 与点到点/共享媒介场景是否匹配？
- `replayWindow` 是否与链路乱序特性匹配？
- 机密性偏移与 VLAN 插位是否按预期？

---

## 3.11 常见联调/排错场景（对症下药）

- 互 ping 不通但抓到 0x88E5：多为 VALIDATE 失败或重放窗口过紧；比对 Cipher Suite/偏移/密钥与窗口。
- 看不到 0x88E5：
  - 抓错口（应抓物理口）；
  - SecY 尚未进入保护状态（认证未完成/策略仅验证不保护）；
  - VLAN/ACL 在 MACsec 之上阻断了业务路径。
- ICV failures 飙升：重点检查两端 SAK 是否一致、机密性偏移/插位是否一致、是否跨 Suite。
- PN too old/too high：窗口/乱序与多路径；或出现重复帧/回放攻击；LAG 环境建议按优先级拆分 SC。

---

## 3.12 关联规范与进一步阅读

- 协议与操作：Clause 8（docs/clauses/08-macsec-protocol.md）、Clause 10（docs/clauses/10-secy-operation.md）
- 帧编码与字段：Clause 9（docs/clauses/09-macsec-encoding.md）
- 密码套件：Clause 14（docs/clauses/14-cipher-suites.md）与“文章 6 — 密码套件与密钥策略”（docs/tutorials/06-密码套件与密钥策略.md）
- 系统与部署：Clause 11（docs/clauses/11-macsec-systems.md）、“文章 5 — 走向生产”（docs/tutorials/05-走向生产-部署指南.md）

---

## 3.13 小结与下一步

至此你已经：

- 搭建了 SecY/PAE/KaY 的心智模型，理解 CA/SC/SA 的层次与 AN 轮换；
- 能够逐步追踪发送/接收路径，识别关键字段与计数器；
- 理解重放窗口、重键、机密性偏移、XPN 与 MTU 的工程影响。

下一步推荐：

- 跟随“文章 4 — 动手实验”（docs/tutorials/04-动手实验-最小网络.md）把最小网络跑起来；
- 查阅“文章 5/6/7”完成生产部署、策略选择与监控运维闭环。

---

## 3.14 附：典型报文十六进制注释示例

本节给出一帧“携带 SCI、开启机密性（C=1）”的典型 MACsec 报文外观，便于你把抓包结果对齐字段。注意：TCI/AN 的具体位布局以标准为准；下例的 TCI/AN 数值仅用于示意“SC=1、C=1、启用重放保护、AN=1”这类组合，Secure Data 与 ICV 也会因密钥/明文不同而变化。

示例 A（带 SCI + C=1）：

```
0000  00 11 22 33 44 55  66 77 88 99 aa bb  88 e5  51 00
       |<----- DA ----->|  |<----- SA ----->|  |Eth| TCI/AN SL|

0010  00 00 00 01  66 77 88 99 aa bb 00 01  5a 6b 7c 8d
       |<-- PN LSB32 -->|  |<--------  SCI (MAC+PortID) ------>|

0020  9e af b0 c1 d2 e3 f4 05  16 27 38 49 5a 6b 7c 8d
       |<------------------ Secure Data （密文，长度可变） ------------------|

0030  9e af b0 c1 d2 e3 f4 05  16 27 38 49 5a 6b 7c 8d
       |<------------------------------ ICV (16B) -------------------------->|
```

逐字段对照：

- DA（目的 MAC）`00-11-22-33-44-55`
- SA（源 MAC）`66-77-88-99-AA-BB`
- EtherType `88-E5`（表明是 MACsec 帧）
- TCI/AN `0x51`（示意）：
  - SC=1（显式携带 SCI）
  - C=1（机密性开启）
  - Replay=1（启用重放保护）
  - AN=1（选用发送 SC 的第 1 条 SA）
- SL `0x00`（未使用短长度；后续有效载荷 ≥ 48B）
- PN（低 32 位）`00 00 00 01`（XPN 时接收端会重建高 32 位）
- SCI `66-77-88-99-AA-BB-00-01`（发送者 MAC + PortID）
- Secure Data：业务载荷的密文（或依配置保留部分明文的“机密性偏移”）
- ICV：完整性校验值（常见 16B，覆盖 DA/SA + SecTAG + Secure Data）

抓包建议：

- 在物理口抓链路帧：`tcpdump -i ethX -nn -vv -xx ether proto 0x88e5`
- 关注 PN 单调递增、TCI/AN 与 SCI 的一致性；验证失败时 ICV 无法比对。

变体速览（不展开十六进制）：

- 不带 SCI（SC=0）：在点到点单 SC 的场景中常见，SecTAG 将比上例少 8B；其余一致。
- 不加密（C=0）：Secure Data 为明文（仍受 ICV 保护）；短帧时 SL 会指示 ICV 位置。
